{% load static %}

<div class="test d-flex flex-row justify-content-start flex-wrap gap-3">
    {% for review in reviews %}
        <div class="review-card">
            <div class="d-flex justify-content-start align-items-start p-3 ms-4">
                <img src="



                        {% if review.user.image %}{{ review.user.image.url }}{% else %}{% static 'deps/images/baseavatar.jpg' %}{% endif %}"
                     alt="Profile Picture">
                <div class="ps-3">
                    <div class="d-flex justify-content-start align-items-center">
                        <div class="me-4">
                            <p class="mb-0 mont-reg name-item">{{ review.user.username }}</p>
                            <p class="mont-bold">{{ review.review_date|date:"d M Y" }}</p>
                        </div>
                        <div class="product-rating ms-5">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}
                                    <i class="fas fa-star"></i>
                                {% elif forloop.counter == review.rating|add:0.5 %}
                                    <i class="fas fa-star-half-alt"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <p>{{ review.comment }}</p>
                </div>

            </div>
            {% if review.user == request.user %}
                <div class="d-flex justify-content-end mt-4 me-4">
                    <button class="transparent-btn ms-2" data-bs-toggle="modal"
                            data-bs-target="#updateReviewModal-{{ review.id }}">‚úèÔ∏è
                    </button>
                    <button class="transparent-btn ms-2" data-bs-toggle="modal"
                            data-bs-target="#deleteReviewModal-{{ review.id }}">üóë
                    </button>
                </div>


                <div class="modal" id="updateReviewModal-{{ review.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="post" action="{% url 'goods:update_review' review.id %}">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å –æ—Ç–∑—ã–≤</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="rating d-flex justify-content-evenly mb-3">
                                        {% for star in "12345" %}
                                            <i class="fas fa-star star-rating {% if forloop.counter <= review.rating %}text-warning{% else %}far{% endif %}"
                                               data-value="{{ forloop.counter }}"
                                               data-target="ratingInput-{{ review.id }}"></i>
                                        {% endfor %}
                                        <input type="hidden" name="rating" id="ratingInput-{{ review.id }}"
                                               value="{{ review.rating }}">
                                    </div>
                                    <textarea name="comment"
                                              class="form-control">{{ review.comment }}</textarea>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>


                <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
                <div class="modal" id="deleteReviewModal-{{ review.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="post" action="{% url 'goods:delete_review' review.id %}">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title">–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                                </div>
                                <div class="modal-body">
                                    –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            {% endif %}
        </div>

    {% empty %}
        <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ —ç—Ç–æ—Ç –ø—Ä–æ–¥—É–∫—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
    {% endfor %}
</div>

<style>
    .name-item {
        font-size: 15px;
    }

    .review-card {
        height: 250px;
        width: 450px;
        background-color: rgba(128, 128, 128, 0.068);
        border-radius: 20px;
    }

    .review-card img {
        height: 70px;
        width: 70px;
        border-radius: 50%;
        box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
    }

    .transparent-btn {
        background-color: transparent; /* –£–±–∏—Ä–∞–µ—Ç —Ñ–æ–Ω */
        border: none; /* –£–±–∏—Ä–∞–µ—Ç —Ä–∞–º–∫—É */
        color: inherit; /* –ù–∞—Å–ª–µ–¥—É–µ—Ç —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è */
        padding: 0; /* –£–±–∏—Ä–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        font: inherit; /* –ù–∞—Å–ª–µ–¥—É–µ—Ç —à—Ä–∏—Ñ—Ç –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è */
        cursor: pointer; /* –£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –∫–Ω–æ–ø–∫–∞ */
    }
</style>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const deleteForms = document.querySelectorAll("form[action*='delete']");
        const updateForms = document.querySelectorAll("form[action*='update']");

        deleteForms.forEach(form => {
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                fetch(this.action, {
                    method: "POST",
                    headers: {"X-CSRFToken": "{{ csrf_token }}"}
                }).then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            {#alert("–û—Ç–∑—ã–≤ —É–¥–∞–ª–µ–Ω");#}
                            location.reload();
                        } else {
                            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
                        }
                    });
            });
        });

        updateForms.forEach(form => {
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, {
                    method: "POST",
                    body: formData,
                    headers: {"X-CSRFToken": "{{ csrf_token }}"}
                }).then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            {#alert("–û—Ç–∑—ã–≤ –∏–∑–º–µ–Ω–µ–Ω");#}
                            location.reload();
                        } else {
                            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏");
                        }
                    });
            });
        });
    });

</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–≤–µ–∑–¥ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞
        const stars = document.querySelectorAll(".star-rating");
        stars.forEach(star => {
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–≤–µ–∑–¥ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
            star.addEventListener("mouseover", function () {
                const ratingInputId = this.getAttribute("data-target");
                highlightStars(this.getAttribute("data-value"), ratingInputId);
            });

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ
            star.addEventListener("click", function () {
                const ratingInputId = this.getAttribute("data-target");
                const ratingInput = document.getElementById(ratingInputId);
                const selectedRating = this.getAttribute("data-value");
                ratingInput.value = selectedRating;
                highlightStars(selectedRating, ratingInputId); // –ó–∞–∫—Ä–µ–ø–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
            });

            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É, –µ—Å–ª–∏ –∑–≤–µ–∑–¥–∞ –Ω–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞
            star.addEventListener("mouseleave", function () {
                const ratingInputId = this.getAttribute("data-target");
                const ratingInput = document.getElementById(ratingInputId);
                highlightStars(ratingInput.value, ratingInputId);
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∑–≤–µ–∑–¥ –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
        function highlightStars(rating, inputId) {
            const starsGroup = document.querySelectorAll(`[data-target="${inputId}"]`);
            starsGroup.forEach(star => {
                if (star.getAttribute("data-value") <= rating) {
                    star.classList.add("text-warning", "fas");
                    star.classList.remove("far");
                } else {
                    star.classList.remove("text-warning", "fas");
                    star.classList.add("far");
                }
            });
        }
    });
</script>
